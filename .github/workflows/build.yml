name: Build iOS App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app
          echo "Xcode version:"
          xcodebuild -version
          
      - name: Install xcodegen (for Xcode project generation)
        run: brew install xcodegen
          
      - name: Read config
        id: config
        run: |
          echo "Reading config.json..."
          APP_NAME=$(jq -r '.app_name' config.json)
          BUNDLE_ID=$(jq -r '.bundle_id' config.json)
          VERSION=$(jq -r '.version' config.json)
          BUILD_NUM=$(jq -r '.build_number' config.json)
          MIN_IOS=$(jq -r '.minimum_ios' config.json)
          ORIENTATION=$(jq -r '.orientation' config.json)
          
          # Convert orientation to Xcode format
          if [ "$ORIENTATION" = "portrait" ]; then
              ORIENTATION_JSON='["UIInterfaceOrientationPortrait"]'
          elif [ "$ORIENTATION" = "landscape" ]; then
              ORIENTATION_JSON='["UIInterfaceOrientationLandscapeLeft", "UIInterfaceOrientationLandscapeRight"]'
          else
              ORIENTATION_JSON='["UIInterfaceOrientationPortrait", "UIInterfaceOrientationLandscapeLeft", "UIInterfaceOrientationLandscapeRight"]'
          fi
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "MIN_IOS=$MIN_IOS" >> $GITHUB_OUTPUT
          echo "ORIENTATION_JSON=$ORIENTATION_JSON" >> $GITHUB_OUTPUT
          
      - name: Copy Resources
        run: |
          echo "Setting up resources..."
          mkdir -p App/Resources
          cp -r Resources/ App/Resources/ 2>/dev/null || echo "No custom resources, using defaults"
          
      - name: Generate Info.plist
        run: |
          echo "Generating Info.plist..."
          
          # Set orientation strings
          if [ "${{ steps.config.outputs.ORIENTATION_JSON }}" = '["UIInterfaceOrientationPortrait"]' ]; then
              PORTRAIT="<string>UIInterfaceOrientationPortrait</string>"
              LANDSCAPE=""
          elif [ "${{ steps.config.outputs.ORIENTATION_JSON }}" = '["UIInterfaceOrientationLandscapeLeft", "UIInterfaceOrientationLandscapeRight"]' ]; then
              PORTRAIT=""
              LANDSCAPE="<string>UIInterfaceOrientationLandscapeLeft</string><string>UIInterfaceOrientationLandscapeRight</string>"
          else
              PORTRAIT="<string>UIInterfaceOrientationPortrait</string>"
              LANDSCAPE="<string>UIInterfaceOrientationLandscapeLeft</string><string>UIInterfaceOrientationLandscapeRight</string>"
          fi
          
          # Escape for sed
          PORTRAIT_ESC=$(echo "$PORTRAIT" | sed 's/[\/&]/\\&/g')
          LANDSCAPE_ESC=$(echo "$LANDSCAPE" | sed 's/[\/&]/\\&/g')
          
          sed -e "s/{{APP_NAME}}/${{ steps.config.outputs.APP_NAME }}/g" \
              -e "s/{{BUNDLE_ID}}/${{ steps.config.outputs.BUNDLE_ID }}/g" \
              -e "s/{{VERSION}}/${{ steps.config.outputs.VERSION }}/g" \
              -e "s/{{BUILD_NUMBER}}/${{ steps.config.outputs.BUILD_NUM }}/g" \
              -e "s/{{MINIMUM_IOS}}/${{ steps.config.outputs.MIN_IOS }}/g" \
              -e "s/{{ORIENTATION_PORTRAIT}}/$PORTRAIT_ESC/g" \
              -e "s/{{ORIENTATION_LANDSCAPE}}/$LANDSCAPE_ESC/g" \
              App/Info.plist.template > App/Info.plist
          
          echo "âœ… Info.plist generated"
          
      - name: Create Xcode project with xcodegen
        run: |
          cd App
          
          # Create project.yml for xcodegen
          cat > project.yml << EOF
          name: ${{ steps.config.outputs.APP_NAME }}
          options:
            bundleIdPrefix: ${{ steps.config.outputs.BUNDLE_ID }}
            deploymentTarget:
              iOS: ${{ steps.config.outputs.MIN_IOS }}
          targets:
            ${{ steps.config.outputs.APP_NAME }}:
              type: application
              platform: iOS
              sources: 
                - path: Sources
              info:
                path: Info.plist
                properties:
                  CFBundleName: ${{ steps.config.outputs.APP_NAME }}
                  CFBundleDisplayName: ${{ steps.config.outputs.APP_NAME }}
                  CFBundleIdentifier: ${{ steps.config.outputs.BUNDLE_ID }}
                  CFBundleVersion: ${{ steps.config.outputs.BUILD_NUM }}
                  CFBundleShortVersionString: ${{ steps.config.outputs.VERSION }}
                  UISupportedInterfaceOrientations: ${{ steps.config.outputs.ORIENTATION_JSON }}
                  UISupportedInterfaceOrientations~ipad: ${{ steps.config.outputs.ORIENTATION_JSON }}
                  LSRequiresIPhoneOS: true
                  UIRequiredDeviceCapabilities: [armv7]
              settings:
                base:
                  PRODUCT_BUNDLE_IDENTIFIER: ${{ steps.config.outputs.BUNDLE_ID }}
                  PRODUCT_NAME: ${{ steps.config.outputs.APP_NAME }}
                  TARGETED_DEVICE_FAMILY: 1,2
                  DEVELOPMENT_TEAM: ""
                  CODE_SIGN_IDENTITY: "Apple Development"
                  CODE_SIGN_STYLE: Automatic
              dependencies:
                - framework: Foundation.framework
                  weak: false
                - framework: UIKit.framework
                  weak: false
                - framework: SwiftUI.framework
                  weak: false
                - framework: Combine.framework
                  weak: false
          EOF
          
          # Generate Xcode project
          xcodegen generate
          echo "âœ… Xcode project generated"
          
      - name: Build with xcodebuild
        run: |
          cd App
          
          # Build the app
          xcodebuild -scheme "${{ steps.config.outputs.APP_NAME }}" \
                     -destination 'generic/platform=iOS' \
                     -configuration Release \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     clean build \
                     -quiet
          
          echo "âœ… Build successful"
          
      - name: Find built .app
        run: |
          cd App
          
          # Look for the built .app
          APP_PATH=$(find build -name "*.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "*.app" -type d | head -1)
          fi
          
          if [ -n "$APP_PATH" ]; then
            echo "Found app at: $APP_PATH"
            # Copy to known location
            cp -r "$APP_PATH" "../${{ steps.config.outputs.APP_NAME }}.app"
          else
            echo "âŒ No .app found!"
            echo "Listing build directory:"
            find . -name "*" -type f | head -20
            exit 1
          fi
          
      - name: Create .ipa
        run: |
          # Create Payload directory
          mkdir -p Payload
          mv "${{ steps.config.outputs.APP_NAME }}.app" Payload/
          
          # Create .ipa
          zip -qr "${{ steps.config.outputs.APP_NAME }}.ipa" Payload
          echo "âœ… IPA created: ${{ steps.config.outputs.APP_NAME }}.ipa"
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iOS-App
          path: |
            *.ipa
            Payload/
          retention-days: 7
          
      - name: Show Success
        run: |
          echo "ðŸŽ‰ BUILD SUCCESSFUL!"
          echo "App: ${{ steps.config.outputs.APP_NAME }}"
          echo "Bundle ID: ${{ steps.config.outputs.BUNDLE_ID }}"
          echo "Version: ${{ steps.config.outputs.VERSION }} (${{ steps.config.outputs.BUILD_NUM }})"
          echo "Download the .ipa from the Artifacts section!"
