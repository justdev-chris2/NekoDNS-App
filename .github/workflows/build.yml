name: Build iOS App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app
          echo "Xcode version:"
          xcodebuild -version
          
      - name: Install xcodegen
        run: brew install xcodegen
          
      - name: Read config
        id: config
        run: |
          echo "Reading config.json..."
          APP_NAME=$(jq -r '.app_name' config.json)
          BUNDLE_ID=$(jq -r '.bundle_id' config.json)
          VERSION=$(jq -r '.version' config.json)
          BUILD_NUM=$(jq -r '.build_number' config.json)
          MIN_IOS=$(jq -r '.minimum_ios' config.json)
          ORIENTATION=$(jq -r '.orientation' config.json)
          
          # Convert orientation to Xcode format
          if [ "$ORIENTATION" = "portrait" ]; then
              ORIENTATION_JSON='["UIInterfaceOrientationPortrait"]'
          elif [ "$ORIENTATION" = "landscape" ]; then
              ORIENTATION_JSON='["UIInterfaceOrientationLandscapeLeft", "UIInterfaceOrientationLandscapeRight"]'
          else
              ORIENTATION_JSON='["UIInterfaceOrientationPortrait", "UIInterfaceOrientationLandscapeLeft", "UIInterfaceOrientationLandscapeRight"]'
          fi
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "MIN_IOS=$MIN_IOS" >> $GITHUB_OUTPUT
          echo "ORIENTATION_JSON=$ORIENTATION_JSON" >> $GITHUB_OUTPUT
          
      - name: Setup Resources
        run: |
          echo "Setting up resources..."
          mkdir -p App/Resources
          # Copy custom icon if provided
          if [ -f "Resources/Assets.xcassets/AppIcon.appiconset/icon-1024.png" ]; then
            cp -r Resources/ App/Resources/
            echo "âœ“ Using custom icon"
          else
            echo "âœ“ Using default icon"
          fi
          
      - name: Generate Info.plist
        run: |
          echo "Generating Info.plist..."
          
          # STRIP BOM USING PERL
          perl -pe 's/^\xEF\xBB\xBF//' App/Info.plist.template > App/Info.plist.tmp
          
          # Set orientation strings
          if [ "${{ steps.config.outputs.ORIENTATION_JSON }}" = '["UIInterfaceOrientationPortrait"]' ]; then
              PORTRAIT="<string>UIInterfaceOrientationPortrait</string>"
              LANDSCAPE=""
          elif [ "${{ steps.config.outputs.ORIENTATION_JSON }}" = '["UIInterfaceOrientationLandscapeLeft", "UIInterfaceOrientationLandscapeRight"]' ]; then
              PORTRAIT=""
              LANDSCAPE="<string>UIInterfaceOrientationLandscapeLeft</string><string>UIInterfaceOrientationLandscapeRight</string>"
          else
              PORTRAIT="<string>UIInterfaceOrientationPortrait</string>"
              LANDSCAPE="<string>UIInterfaceOrientationLandscapeLeft</string><string>UIInterfaceOrientationLandscapeRight</string>"
          fi
          
          # Escape for sed
          PORTRAIT_ESC=$(echo "$PORTRAIT" | sed 's/[\/&]/\\&/g')
          LANDSCAPE_ESC=$(echo "$LANDSCAPE" | sed 's/[\/&]/\\&/g')
          
          # Process the template
          sed -e "s/{{APP_NAME}}/${{ steps.config.outputs.APP_NAME }}/g" \
              -e "s/{{BUNDLE_ID}}/${{ steps.config.outputs.BUNDLE_ID }}/g" \
              -e "s/{{VERSION}}/${{ steps.config.outputs.VERSION }}/g" \
              -e "s/{{BUILD_NUMBER}}/${{ steps.config.outputs.BUILD_NUM }}/g" \
              -e "s/{{MINIMUM_IOS}}/${{ steps.config.outputs.MIN_IOS }}/g" \
              -e "s/{{ORIENTATION_PORTRAIT}}/$PORTRAIT_ESC/g" \
              -e "s/{{ORIENTATION_LANDSCAPE}}/$LANDSCAPE_ESC/g" \
              App/Info.plist.tmp > App/Info.plist
          
          rm -f App/Info.plist.tmp
          echo "âœ… Info.plist generated"
          
      - name: Create Xcode Project
        run: |
          cd App
          
          # Create project.yml for xcodegen
          cat > project.yml << EOF
          name: ${{ steps.config.outputs.APP_NAME }}
          options:
            bundleIdPrefix: ${{ steps.config.outputs.BUNDLE_ID }}
            deploymentTarget:
              iOS: ${{ steps.config.outputs.MIN_IOS }}
          targets:
            ${{ steps.config.outputs.APP_NAME }}:
              type: application
              platform: iOS
              sources: 
                - path: Sources
              info:
                path: Info.plist
              settings:
                base:
                  PRODUCT_BUNDLE_IDENTIFIER: ${{ steps.config.outputs.BUNDLE_ID }}
                  PRODUCT_NAME: ${{ steps.config.outputs.APP_NAME }}
                  TARGETED_DEVICE_FAMILY: "1,2"
                  CODE_SIGNING_ALLOWED: NO
          EOF
          
          # Generate Xcode project
          xcodegen generate
          echo "âœ… Xcode project generated"
          
      - name: Build with xcodebuild
        run: |
          cd App
          
          # Build with explicit output path
          xcodebuild -scheme "${{ steps.config.outputs.APP_NAME }}" \
                     -destination 'generic/platform=iOS' \
                     -configuration Release \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     -derivedDataPath Build \
                     clean build \
                     -quiet
          
          echo "âœ… Build complete"
          
      - name: Find Built App
        run: |
          cd App
          
          # Look for .app in build directory
          APP_PATH=$(find "Build/Build/Products/Release-iphoneos" -name "*.app" -type d 2>/dev/null | head -1)
          
          if [ -z "$APP_PATH" ]; then
            # Fallback search
            APP_PATH=$(find . -name "*.app" -type d | head -1)
          fi
          
          if [ -n "$APP_PATH" ]; then
            echo "Found app: $APP_PATH"
            cp -r "$APP_PATH" "../${{ steps.config.outputs.APP_NAME }}.app"
          else
            echo "âŒ No .app found!"
            echo "Build directory contents:"
            find Build -type f 2>/dev/null | head -20
            exit 1
          fi
          
      - name: Create Standard .ipa
        run: |
          # Standard .ipa with Payload/ folder (for AltStore)
          mkdir -p Payload
          mv "${{ steps.config.outputs.APP_NAME }}.app" Payload/
          zip -qr "${{ steps.config.outputs.APP_NAME }}.ipa" Payload
          echo "âœ… Standard .ipa created (for AltStore)"
          
      - name: Create Appetize .zip
        run: |
          # Appetize format: .app directly in zip
          cp -r "Payload/${{ steps.config.outputs.APP_NAME }}.app" ./
          zip -qr "${{ steps.config.outputs.APP_NAME }}-appetize.zip" \
               "${{ steps.config.outputs.APP_NAME }}.app"
          echo "âœ… Appetize .zip created (for browser testing)"
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iOS-App
          path: |
            *.ipa
            *-appetize.zip
            Payload/
          retention-days: 7
          
      - name: Show Success
        run: |
          echo "ðŸŽ‰ BUILD SUCCESSFUL!"
          echo "App: ${{ steps.config.outputs.APP_NAME }}"
          echo "Bundle ID: ${{ steps.config.outputs.BUNDLE_ID }}"
          echo "Version: ${{ steps.config.outputs.VERSION }} (${{ steps.config.outputs.BUILD_NUM }})"
          echo ""
          echo "ðŸ“± DOWNLOADS:"
          echo "- ${{ steps.config.outputs.APP_NAME }}.ipa â†’ Install with AltStore"
          echo "- ${{ steps.config.outputs.APP_NAME }}-appetize.zip â†’ Upload to Appetize.io"
          echo ""
          echo "âœ… Ready for testing!"
