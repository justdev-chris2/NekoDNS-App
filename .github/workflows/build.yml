name: Build iOS App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app
          echo "Xcode version:"
          xcodebuild -version
          
      - name: Install xcodegen
        run: brew install xcodegen
          
      - name: Read config
        id: config
        run: |
          echo "Reading config.json..."
          APP_NAME=$(jq -r '.app_name' config.json)
          BUNDLE_ID=$(jq -r '.bundle_id' config.json)
          VERSION=$(jq -r '.version' config.json)
          BUILD_NUM=$(jq -r '.build_number' config.json)
          MIN_IOS=$(jq -r '.minimum_ios' config.json)
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "MIN_IOS=$MIN_IOS" >> $GITHUB_OUTPUT
          
      - name: Generate Info.plist from scratch
        env:
          APP_NAME: ${{ steps.config.outputs.APP_NAME }}
          BUNDLE_ID: ${{ steps.config.outputs.BUNDLE_ID }}
          VERSION: ${{ steps.config.outputs.VERSION }}
          BUILD_NUM: ${{ steps.config.outputs.BUILD_NUM }}
          MIN_IOS: ${{ steps.config.outputs.MIN_IOS }}
        run: |
          echo "Generating Info.plist..."
          cat > App/Info.plist << EOF
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
                <key>CFBundleDevelopmentRegion</key>
                <string>en</string>
                <key>CFBundleExecutable</key>
                <string>${APP_NAME}</string>
                <key>CFBundleIdentifier</key>
                <string>${BUNDLE_ID}</string>
                <key>CFBundleInfoDictionaryVersion</key>
                <string>6.0</string>
                <key>CFBundleName</key>
                <string>${APP_NAME}</string>
                <key>CFBundlePackageType</key>
                <string>APPL</string>
                <key>CFBundleShortVersionString</key>
                <string>${VERSION}</string>
                <key>CFBundleVersion</key>
                <string>${BUILD_NUM}</string>
                <key>LSRequiresIPhoneOS</key>
                <true/>
                <key>MinimumOSVersion</key>
                <string>${MIN_IOS}</string>
                <key>UIDeviceFamily</key>
                <array>
                    <integer>1</integer>
                    <integer>2</integer>
                </array>
                <key>UILaunchScreen</key>
                <dict/>
                <key>UIRequiredDeviceCapabilities</key>
                <array>
                    <string>arm64</string>
                </array>
                <key>UISupportedInterfaceOrientations~iphone</key>
                <array>
                    <string>UIInterfaceOrientationPortrait</string>
                </array>
                <key>UISupportedInterfaceOrientations~ipad</key>
                <array>
                    <string>UIInterfaceOrientationPortrait</string>
                    <string>UIInterfaceOrientationLandscapeLeft</string>
                    <string>UIInterfaceOrientationLandscapeRight</string>
                </array>
            </dict>
            </plist>
          EOF
          echo "✅ Info.plist generated"
          
      - name: Create project.yml for xcodegen
        run: |
          cd App
          cat > project.yml << EOF
            name: ${{ steps.config.outputs.APP_NAME }}
            options:
              bundleIdPrefix: ${{ steps.config.outputs.BUNDLE_ID }}
              deploymentTarget:
                iOS: ${{ steps.config.outputs.MIN_IOS }}
            targets:
              ${{ steps.config.outputs.APP_NAME }}:
                type: application
                platform: iOS
                sources: 
                  - path: Sources
                info:
                  path: Info.plist
                settings:
                  base:
                    PRODUCT_BUNDLE_IDENTIFIER: ${{ steps.config.outputs.BUNDLE_ID }}
                    PRODUCT_NAME: ${{ steps.config.outputs.APP_NAME }}
                    TARGETED_DEVICE_FAMILY: "1,2"
                    CODE_SIGNING_ALLOWED: NO
          EOF
          
      - name: Generate Xcode project
        run: |
          cd App
          xcodegen generate
          echo "✅ Xcode project generated"
          
      - name: Build with xcodebuild
        run: |
          cd App
          xcodebuild -project "${{ steps.config.outputs.APP_NAME }}.xcodeproj" \
                     -scheme "${{ steps.config.outputs.APP_NAME }}" \
                     -destination 'generic/platform=iOS' \
                     -configuration Release \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     -derivedDataPath Build \
                     clean build
          
      - name: Find Built App
        run: |
          cd App
          
          APP_PATH=$(find "Build/Build/Products/Release-iphoneos" -name "*.app" -type d 2>/dev/null | head -1)
          
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "*.app" -type d | head -1)
          fi
          
          if [ -n "$APP_PATH" ]; then
            echo "Found app: $APP_PATH"
            cp -r "$APP_PATH" "../${{ steps.config.outputs.APP_NAME }}.app"
          else
            echo "❌ No .app found!"
            exit 1
          fi

      - name: Strip BOM from compiled app
        run: |
          perl -pi -e 's/^\xEF\xBB\xBF//' "${{ steps.config.outputs.APP_NAME }}.app/Info.plist"

      - name: Debug plist hex
        run: |
          xxd "${{ steps.config.outputs.APP_NAME }}.app/Info.plist" | head -1
          
      - name: Create Standard .ipa
        run: |
          mkdir -p Payload
          mv "${{ steps.config.outputs.APP_NAME }}.app" Payload/
          zip -qr "${{ steps.config.outputs.APP_NAME }}.ipa" Payload
          
      - name: Create Appetize .zip
        run: |
          cp -r "Payload/${{ steps.config.outputs.APP_NAME }}.app" ./
          zip -qr "${{ steps.config.outputs.APP_NAME }}-appetize.zip" \
               "${{ steps.config.outputs.APP_NAME }}.app"
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iOS-App
          path: |
            *.ipa
            *-appetize.zip
          retention-days: 7
