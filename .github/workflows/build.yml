name: Build iOS App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app
          echo "Xcode version:"
          xcodebuild -version
          
      - name: Read config
        id: config
        run: |
          echo "Reading config.json..."
          APP_NAME=$(jq -r '.app_name' config.json)
          BUNDLE_ID=$(jq -r '.bundle_id' config.json)
          VERSION=$(jq -r '.version' config.json)
          BUILD_NUM=$(jq -r '.build_number' config.json)
          MIN_IOS=$(jq -r '.minimum_ios' config.json)
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "MIN_IOS=$MIN_IOS" >> $GITHUB_OUTPUT
          
      - name: Generate Info.plist from template
        run: |
          echo "Generating Info.plist..."
          cp App/Info.plist.template App/Info.plist
          
          # Replace variables
          sed -i '' "s/{{APP_NAME}}/${{ steps.config.outputs.APP_NAME }}/g" App/Info.plist
          sed -i '' "s/{{BUNDLE_ID}}/${{ steps.config.outputs.BUNDLE_ID }}/g" App/Info.plist
          sed -i '' "s/{{VERSION}}/${{ steps.config.outputs.VERSION }}/g" App/Info.plist
          sed -i '' "s/{{BUILD_NUMBER}}/${{ steps.config.outputs.BUILD_NUM }}/g" App/Info.plist
          sed -i '' "s/{{MINIMUM_IOS}}/${{ steps.config.outputs.MIN_IOS }}/g" App/Info.plist
          
          echo "✅ Info.plist generated"
          
      - name: Build with xcodebuild
        run: |
          cd App
          xcodebuild -project NekoDNS.xcodeproj \
                     -scheme NekoDNS \
                     -destination 'generic/platform=iOS' \
                     -configuration Release \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     -derivedDataPath Build \
                     clean build
          
          echo "✅ Build complete"
          
      - name: Find Built App
        run: |
          cd App
          
          APP_PATH=$(find "Build/Build/Products/Release-iphoneos" -name "*.app" -type d 2>/dev/null | head -1)
          
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "*.app" -type d | head -1)
          fi
          
          if [ -n "$APP_PATH" ]; then
            echo "Found app: $APP_PATH"
            cp -r "$APP_PATH" "../${{ steps.config.outputs.APP_NAME }}.app"
          else
            echo "❌ No .app found!"
            exit 1
          fi
          
      - name: Create .ipa
        run: |
          mkdir -p Payload
          mv "${{ steps.config.outputs.APP_NAME }}.app" Payload/
          zip -qr "${{ steps.config.outputs.APP_NAME }}.ipa" Payload
          echo "✅ .ipa created"
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iOS-App
          path: "*.ipa"
          retention-days: 7
